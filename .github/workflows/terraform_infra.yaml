name: Terraform Infra Resource 
on: 
  push:
    # branches:
    #   - main
  workflow_dispatch:
  jobs:
    terraform:
      name: "Terraform Infra Resource"
      runs-on: ubuntu-latest
      environment: test
      steps:
        - name: Checkout Repository
          uses: actions/checkout@v3

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v2
          with:
            terraform_version: 1.7.6
        - name: azure login
          uses: azure/login@v1
          with:
            creds: ${{ secrets.AZURE_CREDENTIALS }}    

        - name: Terraform Init
          run: terraform init

        - name: Terraform Validate
          run: terraform validate

        - name: Terraform Plan
          run: terraform plan -out=tfplan

        - name: Terraform Apply
          if: github.ref == 'refs/heads/main'
          run: terraform apply -auto-approve tfplan
